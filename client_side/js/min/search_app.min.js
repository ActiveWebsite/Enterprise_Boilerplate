var ClientSearch=function(e,t,n,r){this.current_property_type=t,this.save_form=n||!1,this.cma_form=r||!1,this.hasLocalStorage=!1,this.form=jQuery("#"+e),typeof Storage!="undefined"&&(this.hasLocalStorage=!0)};ClientSearch.prototype={counter:!1,autocompleteCache:{},initAdvancedSearch:function(){var e=this;this.buildFormSwap(),this.buildSingletonFormControls(),this.buildFormControls(),this.counter=this.form.formCounter({counterButton:this.save_form?'<input type="submit" title="Save" value="Save" class="btn btn-primary">':'<input type="submit" title="Search" value="Search" class="btn btn-primary">',counterText:"listings found",searchDelay:1,slide_counter:!0,extraClassNames:"",formAction:this.cma_form?"/search/get_url_search_count_cma":"/search/get_url_search_count"}).data("formCounter")},initRefineSearch:function(){var e=this;this.buildSingletonFormControls(),this.buildFormControls(),this.form.find(".expand-block").each(function(){var e=jQuery(this);e.hasClass("ignore")||e.find('input[type="radio"]:checked, input[type="checkbox"]:checked, input[type="text"], input[type="number"], select').each(function(){var t=jQuery(this),n=t.val(),r=!0,i=!1;if(r&&t.is("select")&&t.hasClass("msw2-select")&&t[0].selectedIndex===0)return i=!0,e.show().prev(".expand-trigger").toggleClass("active"),!1;if(r&&n!==null&&n!==""&&n!==" "&&n!=="null"&&n!=="No Min"&&n!=="No Max"&&n!=="Any"&&n!=="All")return i=!0,e.show().prev(".expand-trigger").toggleClass("active"),!1})})},buildSingletonFormControls:function(){this.form.on("click",'input[name="from"]',function(){var e=jQuery(this);e.hasClass("noOpenHouses")?jQuery("#openHouseOn").val(""):jQuery("#openHouseOn").val("on")}),this.form.on("click",".prop_listed_by_field",function(){var e=jQuery(this),t=e.val(),n=jQuery(".listing_agent_select_box");t==="choose_agent"?n.show():(n.hide(),n.val(""))}),this.form.fancySelect2(),this.form.on("click",".expand-trigger",function(){jQuery(this).toggleClass("active").next(".expand-block").slideToggle("fast")})},buildFormControls:function(){this.buildAutoComplete()},buildFormSwap:function(){var e=this,t=this.form.find('input[data-action="change-property-type"]');t.on("click",function(){var n=jQuery(this),r=n.val(),i=n.data("template"),s=jQuery("#dynamic-wrapper"),o={};e.save_form&&(o.save_button=!0),e.cma_form&&(o.cma_form=!0),n.is(":checked")&&r!=e.current_property_type&&(e.counter&&e.counter.Stop(),t.prop("disabled",!0),e.current_property_type=r,i?(jQuery("#dynamic-content").remove(),s.html('<p><img src="/images/ajax-loader.gif" alt=""> Loading new form...</p>'),jQuery.ajax({type:"POST",url:"/search/getSearchFormViaAjax/search_form_prop_types|"+i,data:o,success:function(n){s.html('<div id="dynamic-content">'+n+"</div>"),e.counter&&e.counter.Play(),t.prop("disabled",!1),e.buildFormControls(),e.form.trigger("change")},error:function(n){s.html('<div id="dynamic-content"><div class="alert alert-error">Unable to load the form.</div></div>'),e.counter&&e.counter.Play(),t.prop("disabled",!1),e.form.trigger("change")}})):(e.counter&&e.counter.Play(),t.prop("disabled",!1)))})},buildAutoComplete:function(){function t(e){return e.split(/,\s*/)}function n(e){return t(e).pop()}var e=this;this.form.find(".autoCompleteField").bind("keydown",function(e){try{e.keyCode===jQuery.ui.keyCode.TAB&&jQuery(this).data("autocomplete").menu.active&&e.preventDefault()}catch(t){}}).autocomplete({minLength:2,source:function(t,r){var i=Array(),s=jQuery(this.element).removeClass("ui-autocomplete-loading"),o=s.data("src"),u=e.autocompleteCache[o]||[],a=n(t.term),f=jQuery.ui.autocomplete.escapeRegex(a),l=new RegExp("^"+f,"i"),c="/rest.php/autocomplete/getSearchConfigList?app_key="+booj.application_key+"&pretty_name="+o;e.hasLocalStorage&&(c="/rest.php/autocomplete/getSearchConfigs?app_key="+booj.application_key,u=sessionStorage.getItem(o)?JSON.parse(sessionStorage.getItem(o)):[]);if(f.length<this.options.minLength)return!1;u&&u.length?(i=jQuery.grep(u,function(e){return l.test(e)}),i.length||s.hasClass("validate-entry")&&(s.next(".invalid-auto-complete-entry").remove(),s.after('<span class="invalid-auto-complete-entry">No matches found for <em>'+a+"</em>.</span>")),r(i)):o&&(s.addClass("ui-autocomplete-loading"),jQuery.getJSON(c,function(t){var n=[];s.removeClass("ui-autocomplete-loading");if(t){if(e.hasLocalStorage)for(var u in t.data)t.data.hasOwnProperty(u)&&(u===o&&(n=t.data[u]),sessionStorage.setItem(u,JSON.stringify(t.data[u])));else n=e.autocompleteCache[o]=t.data;i=jQuery.grep(n,function(e){return l.test(e)}),i.length||s.hasClass("validate-entry")&&(s.next(".invalid-auto-complete-entry").remove(),s.after('<span class="invalid-auto-complete-entry">No matches found for <em>'+a+"</em>.</span>")),r(i)}else r(Array())}))},focus:function(){return jQuery(this).next(".invalid-auto-complete-entry").remove(),!1},select:function(e,n){var r=t(this.value);return r.pop(),r.push(n.item.value),r.push(""),this.value=r.join(", "),jQuery(this).next(".invalid-auto-complete-entry").remove(),!1}}).on("blur",function(t){function s(e,t){for(var n=0;n<t.length;n++)if(t[n].toUpperCase()===e.toUpperCase())return n;return-1}var n=jQuery(this),r=n.data("src"),i=e.autocompleteCache[r]||[];e.hasLocalStorage&&(i=sessionStorage.getItem(r)?JSON.parse(sessionStorage.getItem(r)):[]);if(n.hasClass("validate-entry")&&i.length){n.next(".invalid-auto-complete-entry").remove();var o=n.val(),u=o.split(/,\s*/);u=jQuery.grep(u,function(e){return e}),u=u.pop(),u&&u.length&&(u=jQuery.trim(u),s(u,i)===-1&&n.after('<span class="invalid-auto-complete-entry">No matches found for <em>'+u+"</em>.</span>"))}})},buildSliders:function(){function t(e){e+="";var t=/(\d+)(\d{3})/,n=e.split("."),r=n[0],i=n.length>1?"."+n[1]:"";while(t.test(r))r=r.replace(t,"$1,$2");return r+i}function n(e,n,r,i){var s=parseInt(e.val().replace(/[^0-9]/g,""),10),o=parseInt(n.val().replace(/[^0-9]/g,""),10),u=parseInt(r.slider("option","max"),10),a=parseInt(r.slider("option","min"),10),f=e.data("format")||!1,l=n.data("format")||!1;isNaN(s)&&(s=a),isNaN(o)&&(o=u),s>o&&(s=o),o<s&&(o=s),s>u&&(s=u),s<a&&(vi=a),o>u&&(o=u),o<a&&(o=a),i?(s<=a?e.val("No Min"):f&&f==="dollar"?e.val("$"+t(s)):f?e.val(t(s)):e.val(s),o>=u?n.val("No Max"):l&&l==="dollar"?n.val("$"+t(o)):l?n.val(t(o)):n.val(o)):(s<=a?e.val("No Min"):e.val(s),o>=u?n.val("No Max"):n.val(o)),r.slider("values",[s,o])}var e=this;this.form.find(".range").each(function(){var e=jQuery(this),r=e.parent().find('input[data-range="min"]'),i=e.parent().find('input[data-range="max"]'),s=r.data("value")||0,o=i.data("value")||10,u=r.data("step")||1,a=r.val(),f=i.val(),l;if(!r.length||!i.length)return;a==="No Min"?a=s:a=r.val().replace(/[^0-9.]/g,""),f==="No Max"?f=o:f=i.val().replace(/[^0-9.]/g,"");var c=e.slider({range:!0,step:parseFloat(u),min:parseInt(s,10),max:parseInt(o,10),values:[a,f],slide:function(e,n){var s=r.data("format")||!1,o=i.data("format")||!1;s&&s==="dollar"?r.val("$"+t(n.values[0])):s?r.val(t(n.values[0])):r.val(n.values[0]),o&&o==="dollar"?i.val("$"+t(n.values[1])).trigger("change"):o?i.val(t(n.values[1])).trigger("change"):i.val(n.values[1]).trigger("change")}});jQuery.fn.addTouchSupport&&e.addTouchSupport(),r.focus(function(){var e=jQuery(this);e.attr("lastv",e.val()),e.val("")}).blur(function(){var e=jQuery(this);e.val()||e.val(e.attr("lastv"))}).change(function(){n(r,i,c,r.data("format"))}),i.focus(function(){var e=jQuery(this);e.attr("lastv",e.val()),e.val("")}).blur(function(){var e=jQuery(this);e.val()||e.val(e.attr("lastv"))}).change(function(){n(r,i,c,i.data("format"))})})}};